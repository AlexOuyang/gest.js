/* 
 * @name: gest.js
 * @description: gest.js is a webcam based gesture recognition library that helps developers make webpages more immersive.
 * @version: 0.3.1
 * @author: Hadi Michael (http://hadi.io)
 * @license: MIT License
 */

window.gest=(function(l){var F={},L={framerate:25,videoCompressionRate:5,debug:false},K,k,p,N,x,G,q,c=0,f=0;gest=function(){this.options={skinFilter:false,messages:true};if(l.readyState==="complete"){P()}l.addEventListener("DOMContentLoaded",P,false);window.addEventListener("load",P,false);function P(){l.removeEventListener("DOMContentLoaded",P,false);window.removeEventListener("load",P,false);var Q=false;if(I()){Q=true}return m({ready:Q})}return true};var I=function(){if(l.createEventObject){F=l.createEventObject();F.eventType="gest"}else{F=l.createEvent("Event");F.initEvent("gest",true,true)}q=l.createElement("div");l.body.appendChild(q);navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia;if(!navigator.getUserMedia){h(0);return false}k=l.createElement("video");k.width=300;k.setAttribute("style","visibility: hidden;");l.body.appendChild(k);p=l.createElement("canvas");p.setAttribute("style","width: 300px; display: none;");l.body.appendChild(p);N=p.getContext("2d");x=l.createElement("canvas");x.setAttribute("style","visibility: hidden;");l.body.appendChild(x);G=x.getContext("2d");return true};gest.prototype.debug=function(P){if(!navigator.getUserMedia){return false}L.debug=P;if(P){x.setAttribute("style","visibility: visible; position: fixed; left: 0; top: 0; width: 100%; height: 100%; opacity: 1;")}else{x.setAttribute("style","visibility: hidden; position: fixed; left: 0; top: 0; width: 100%; height: 100%; opacity: 1;")}return L.debug};gest.prototype.start=function(){if(!navigator.getUserMedia){return false}if(!k||!(k.paused||k.ended||k.seeking||k.readyState<k.HAVE_FUTURE_DATA)){h(2);return false}if(navigator.getUserMedia){navigator.getUserMedia({audio:false,video:true},function(P){K=P;window.URL=window.URL||window.webkitURL;k.src=window.URL.createObjectURL(K);k.addEventListener("canplaythrough",function(){k.play();c=Math.floor(k.videoWidth/L.videoCompressionRate);f=Math.floor(k.videoHeight/L.videoCompressionRate);setInterval(H,1000/L.framerate);y("The force is strong with you. <br />Go forth and gesture!")})},function(P){if(P.PERMISSION_DENIED){h(10,P)}else{if(P.NOT_SUPPORTED_ERROR){h(11,P)}else{if(P.MANDATORY_UNSATISFIED_ERROR){h(12,P)}else{h(13,P)}}}})}else{h(0)}return !!navigator.getUserMedia};gest.prototype.stop=function(){if(!navigator.getUserMedia){return false}if(k){k.src=""}return !!K.stop()};var H=function(){p.width=c;x.width=c;p.height=f;x.height=f;N.drawImage(k,c,0,-c,f);var P=N.getImageData(0,0,c,f);G.putImageData(P,0,0);if(gest.options.skinFilter){M(B(P),150)}else{M(P,150)}};var i=0,z=0.1,u=0.3,J=1,C=0.4,n=1;var B=function(T){skin_filter=N.getImageData(0,0,c,f);var S=skin_filter.width*skin_filter.height;var R=S*4;var Q=0;for(var U=0;U<f;U++){for(var P=0;P<c;P++){R=P+U*c;r=T.data[Q];g=T.data[Q+1];b=T.data[Q+2];a=T.data[Q+3];hsv=e(r,g,b);if(((hsv[0]>i&&hsv[0]<z)||(hsv[0]>0.59&&hsv[0]<1))&&(hsv[1]>u&&hsv[1]<J)&&(hsv[2]>C&&hsv[2]<n)){skin_filter[Q]=r;skin_filter[Q+1]=g;skin_filter[Q+2]=b;skin_filter[Q+3]=a}else{skin_filter.data[Q]=255;skin_filter.data[Q+1]=255;skin_filter.data[Q+2]=255;skin_filter.data[Q+3]=0}Q=R*4}}return skin_filter};function e(P,S,U){P=P/255;S=S/255;U=U/255;var V=Math.max(P,S,U);var Q=Math.min(P,S,U);var R,X,W=V;var T=V-Q;X=V===0?0:T/V;if(V==Q){R=0}else{switch(V){case P:R=(S-U)/T+(S<U?6:0);break;case S:R=(U-P)/T+2;break;case U:R=(P-S)/T+4;break;default:break}R/=6}return[R,X,W]}var t=false;var M=function(Q,V){delt=N.createImageData(c,f);if(t!==false){var W=0,U=0,R=0,T=delt.width*delt.height,P=T*4;while(P-=4){var S=Math.abs(Q.data[P]-t.data[P])+Math.abs(Q.data[P+1]-t.data[P+1])+Math.abs(Q.data[P+2]-t.data[P+2]);if(S>V){delt.data[P]=255;delt.data[P+1]=0;delt.data[P+2]=0;delt.data[P+3]=255;R+=1;W+=((P/4)%c);U+=(Math.floor((P/4)/delt.height))}else{delt.data[P]=Q.data[P];delt.data[P+1]=Q.data[P+1];delt.data[P+2]=Q.data[P+2];delt.data[P+3]=Q.data[P+3]}}}if(R){v({x:W,y:U,d:R})}t=Q;G.putImageData(delt,0,0)};var j=false,s=2,A=300,w=1000,o=0,O=0;function v(R){var V={x:R.x/R.d,y:R.y/R.d,d:R.d};o=(0.9*o)+(0.1*V.d);var T=V.d-o,U=T>A;switch(O){case 0:if(U){O=1;j={x:V.x,y:V.y,d:V.d}}break;case 1:O=2;var Q=V.x-j.x,P=V.y-j.y;var S=Math.abs(P)<Math.abs(Q);if(Q<-s&&S){m({direction:"Left",left:true})}else{if(Q>s&&S){m({direction:"Right",right:true})}}if(P>s&&!S){if(T>w){m({direction:"Long down",down:true})}else{m({direction:"Down",down:true})}}else{if(P<-s&&!S){if(T>w){m({direction:"Long up",up:true})}else{m({direction:"Up",up:true})}}}y('<span style="line-height: 80px; vertical-align: middle;">'+F.direction+"</span>",50);break;case 2:if(!U){O=0}break;default:break}}var m=function(P){F.direction=P.direction||null;F.up=P.up||false;F.down=P.down||false;F.left=P.left||false;F.right=P.right||false;F.error=P.error||null;F.ready=P.ready||false;try{if(l.createEventObject){return l.fireEvent("on"+F.eventType,F)}else{return l.dispatchEvent(F)}}catch(Q){console.log(F);console.error(Q);return false}};var h=function(P,Q){switch(P){case 0:_error={code:P,message:"Sorry, but gest.js does not support your browser! :("};break;case 1:_error={code:P,message:"gest.js could not start."};break;case 2:_error={code:P,message:"gest has already started."};break;case 10:_error={code:P,message:"DEEEENIED! The user denied permission to use a media device required for the operation.",obj:Q};break;case 11:_error={code:P,message:"A constraint specified is not supported by the browser.",obj:Q};break;case 12:_error={code:P,message:"No media tracks of the type specified in the constraints are found.",obj:Q};break;case 13:_error={code:P,message:"Couldn't get user media.",obj:Q};break;default:_error=null;break}if(L.debug){console.error(_error)}y(_error.message,4000);m({error:_error})};var E=null,d=null,D=false;var y=function(P,T){if(!gest.options.messages||!P){return false}if(D){D=true;return false}var R=T||2500;window.clearTimeout(E);window.clearInterval(d);var Q="visibility: visible; position: fixed; left: 50%; top: 50%; width: 500px; min-height: 80px; margin-left: -250px; margin-top: -40px; padding: 1%; background-color: #222222; border-radius: 10px; z-index: 100; font-family: Arial; color: #FFFFFF; font-size: 35px; text-align: center;";var S=1;q.innerHTML=P;q.setAttribute("style",Q);E=window.setTimeout(function(){d=window.setInterval(function(){if(S-0.1<=0){window.clearInterval(d);q.setAttribute("style","visibility: hidden")}else{S-=0.05;q.setAttribute("style","opacity: "+S+";"+Q)}D=false},40)},R);if(R>=2000){D=true}return true};return new gest()}(document));